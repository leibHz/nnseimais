<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta - Supermercado Veronesi</title>
    
    <script>
        // SCRIPT DE PROTEÇÃO DE ROTA (GUARDA)
        const clienteLogado = JSON.parse(localStorage.getItem('cliente'));
        if (!clienteLogado || !clienteLogado.id_cliente) {
            window.location.href = `login.html?redirect=${window.location.pathname}`;
        }
    </script>

    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/favicon.svg">
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/cc533e21e1.js" crossorigin="anonymous"></script>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo-link">
                <img src="assets/logo.svg" alt="Logotipo Supermercado Veronesi" class="logo">
            </a>
            <nav class="main-nav">
                <!-- O script.js irá atualizar esta área -->
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="welcome-card">
            <h2><i class="fa-solid fa-user-circle"></i> Minha Conta</h2>
            <p>Olá, <strong id="userName"></strong>! Bem-vindo(a) de volta.</p>
        </div>
        
        <section class="order-history-container">
            <h3 class="section-title">Seu Histórico de Encomendas</h3>
            <div id="order-list">
                <!-- O histórico de encomendas será renderizado aqui -->
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 Supermercado Veronesi. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="script.js?v=1.4"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cliente = JSON.parse(localStorage.getItem('cliente'));
            const userNameEl = document.getElementById('userName');
            const orderListEl = document.getElementById('order-list');
            
            // Bug 1: Função para verificar se a sessão do cliente ainda é válida
            async function checkSession() {
                if (!cliente || !cliente.id_cliente) {
                    logout();
                    return;
                }
                try {
                    const response = await fetch(`api/api_cliente_check_session.php?id_cliente=${cliente.id_cliente}`);
                    const result = await response.json();
                    if (!result.valid) {
                        alert("Sua sessão expirou ou a conta foi removida. Por favor, faça login novamente.");
                        logout();
                    }
                } catch (error) {
                    console.error("Erro ao verificar sessão, desconectando por segurança.");
                    logout();
                }
            }

            function logout() {
                localStorage.removeItem('cliente');
                window.location.href = 'login.html';
            }

            if (cliente) {
                userNameEl.textContent = cliente.nome_completo;
                
                // Verifica a sessão ao carregar e depois a cada 20 segundos
                checkSession();
                fetchOrderHistory(cliente.id_cliente);

                setInterval(() => {
                    checkSession(); // Verifica se o usuário ainda existe
                    fetchOrderHistory(cliente.id_cliente);
                }, 20000);
            }

            async function fetchOrderHistory(clienteId) {
                if (!orderListEl.innerHTML.trim() && !orderListEl.querySelector('.loading-spinner')) {
                    orderListEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                }
                
                try {
                    const response = await fetch(`api/api_encomenda_historico.php?id_cliente=${clienteId}&_=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('Falha ao buscar o histórico.');
                    
                    const orders = await response.json();
                    const spinner = orderListEl.querySelector('.loading-spinner');
                    if (spinner) spinner.remove();

                    renderOrderHistory(orders);
                } catch (error) {
                    orderListEl.innerHTML = `<p class="error-message">Não foi possível carregar seu histórico.</p>`;
                }
            }

            function renderOrderHistory(orders) {
                if (!orders || orders.length === 0) {
                    orderListEl.innerHTML = '<p class="empty-message">Você ainda não fez nenhuma encomenda.</p>';
                    return;
                }

                const processedOrderIds = new Set();

                orders.forEach(order => {
                    processedOrderIds.add(String(order.id_encomenda));
                    let orderCard = orderListEl.querySelector(`.order-card[data-order-id='${order.id_encomenda}']`);

                    // Se o card da encomenda não existe, cria um novo
                    if (!orderCard) {
                        orderCard = document.createElement('div');
                        orderCard.className = 'order-card';
                        orderCard.dataset.orderId = order.id_encomenda;
                        orderListEl.insertBefore(orderCard, orderListEl.firstChild); // Insere no topo
                        
                        const formattedDate = new Date(order.data_encomenda).toLocaleString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const formattedTotal = parseFloat(order.valor_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        const statusText = order.status.replace('_', ' ');

                        let itemsHtml = '<ul class="order-item-list">';
                        order.encomenda_itens.forEach(item => {
                            const productName = item.produtos ? item.produtos.nome : 'Produto indisponível';
                            const imageUrl = item.produtos ? item.produtos.imagem_url : 'https://placehold.co/50x50';
                            itemsHtml += `
                                <li class="order-item">
                                    <img src="${imageUrl}" alt="${productName}" onerror="this.src='https://placehold.co/50x50/e53935/ffffff?text=X'">
                                    <div class="order-item-details">
                                        <span>${item.quantidade}x ${productName}</span>
                                    </div>
                                </li>
                            `;
                        });
                        itemsHtml += '</ul>';
                        
                        let justificationHtml = '';
                        if (order.status === 'cancelada' && order.justificativa_cancelamento) {
                            justificationHtml = `<div class="order-justification"><p><strong>Motivo do Cancelamento:</strong> ${order.justificativa_cancelamento}</p></div>`;
                        }

                        orderCard.innerHTML = `
                            <div class="order-header">
                                <div class="order-header-info"><span>Encomenda</span><strong>#${order.id_encomenda}</strong></div>
                                <div class="order-header-info"><span>Data</span><strong>${formattedDate}</strong></div>
                                <div class="order-header-info"><span>Total</span><strong>${formattedTotal}</strong></div>
                                <div class="order-status status-${order.status}">${statusText}</div>
                            </div>
                            <div class="order-body">
                                ${itemsHtml}
                                ${justificationHtml}
                            </div>
                        `;
                    } else {
                        // Se o card já existe, apenas atualiza o status se ele mudou
                        const statusEl = orderCard.querySelector('.order-status');
                        const newStatusClass = `status-${order.status}`;
                        const newStatusText = order.status.replace('_', ' ');

                        if (statusEl && !statusEl.classList.contains(newStatusClass)) {
                            statusEl.className = `order-status ${newStatusClass}`;
                            statusEl.textContent = newStatusText;

                            // Verifica também se a justificativa de cancelamento precisa ser adicionada
                            let justificationEl = orderCard.querySelector('.order-justification');
                            if (order.status === 'cancelada' && order.justificativa_cancelamento && !justificationEl) {
                                const justificationHtml = `<div class="order-justification"><p><strong>Motivo do Cancelamento:</strong> ${order.justificativa_cancelamento}</p></div>`;
                                orderCard.querySelector('.order-body').insertAdjacentHTML('beforeend', justificationHtml);
                            }
                        }
                    }
                });
                
                // Remove da tela os cards de encomendas que não existem mais
                orderListEl.querySelectorAll('.order-card').forEach(card => {
                    if (!processedOrderIds.has(card.dataset.orderId)) {
                        card.remove();
                    }
                });
            }
        });
    </script>
</body>
</html>
